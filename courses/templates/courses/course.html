{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}- {{ course.title }}{% endblock title %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.5.1/min/basic.min.css">
<link rel="stylesheet" href="{% static 'css/course.css' %}">

<div class="ui container">

  <div class="ui grid">
    <div class="six wide column">
      <h1>{{ course.code }}</h1>
    </div>

    {# conditional logic = if there is syllabus uploaded for the course, view syllabus button, if there isn't, show upload syllabus button #}
    <div class="right floated right aligned ten wide column">
      <button onclick="window.location.href = '{% url 'review' category=course.category number=course.number %}'" class="ui floated blue button header-btn">
        Write Review
      </button>
      {% if syllabus %}
      {# view syllabus #}
      <button class="ui right floated button header-btn" id="view-syllabus">View Syllabus</button>

      <div class="ui modal" id="view-modal">
        <i class="close icon"></i>
        <div class="header">
          {{ course.code }} Syllabus
        </div>
        <div id="syllabus"></div>
      </div>
      {% else %}
      {# upload syllabus #}
      <button class="ui button" id="upload-syllabus">Upload Syllabus</button>

      <div class="ui modal" id="upload-modal">
        <i class="close icon"></i>
        <div class="header">
          {{ course.code }} Syllabus Upload
        </div>

        {% if user.is_authenticated %}
        <form method="POST" class="dropzone" enctype="multipart/form-data" id="syllabus-form-ajax" url="{% url 'syllabus' id=course.id %}" action="/file-upload" style="height: 50vh;">
          {% csrf_token %}
        </form>

        <div class="actions">
          <div class="ui black deny button">
            Cancel
          </div>
          <div class="ui positive right labeled icon button" id="syllabus-submit-ajax">
            Submit
            <i class="checkmark icon"></i>
          </div>
        </div>
        {% else %}
        <a href="{% url 'login' %}?next={{request.get_full_path}}" class="item">Login</a>
        <div class="actions">
          <div class="ui black deny button">
            Close
          </div>
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <h3>{{ course.title }}</h3>
  <p>{{ course.description|linebreaks }}</p>
  <p><small>Last Updated: {{ course.updated_at|date:"N jS, Y" }}</small></p>

  <div class="ui horizontal divider">
    <h3 class="header">
      Instructors
      </h4>
  </div>

  {% if course.instructors %}
  <div class="instructor-container">
    {% for instructor in course.instructors %}
    <button class="ui basic small button instructor-button" id="{{ instructor.split|join:"_" }}">
      {{ instructor }}
    </button>
    {% endfor %}
  </div>

  {% else %}
  <p>There are currently no listed instructors for this course.</p>
  {% endif %}

  <div class="ui horizontal divider">
    <h3 class="header">
      {% if reviews %}
      {% if reviews.count > 1 %}
      {{ reviews.count }} Reviews
      {% else %}
      {{ reviews.count }} Review
      {% endif %}
      <div class="ui huge star rating" data-rating="{{ overall_average|floatformat:"0" }}"></div>
      {% else %}
      Reviews
      {% endif %}
    </h3>
  </div>

  {% if reviews %}
  <div class="ui centered grid">
    <div class="four column stackable row">
      <div class="column">
        <h5 class="review-category-heading">Usefulness</h5>:
        <div class="ui star rating" data-rating="{{ usefulness_average|floatformat:"0" }}"></div>
        <span>({{ usefulness_average }})</span>
      </div>
      <div class="column">
        <h5 class="review-category-heading">Difficulty</h5>:
        <div class="ui star rating" data-rating="{{ difficulty_average|floatformat:"0" }}"></div>
        <span>({{ difficulty_average }})</span>
      </div>
      <div class="column">
        <h5 class="review-category-heading">Instructor</h5>:
        <div class="ui star rating" data-rating="{{ instructor_average|floatformat:"0" }}"></div>
        <span>({{ instructor_average }})</span>
      </div>
    </div>
  </div>
  {% else %}
  <p>There are currently no reviews for this course.</p>
  {% endif %}

  <div class="ui divider"></div>
  {% if reviews %}
  <div class="reviews">
    {% for review in reviews %}
    <div class="review" data-instructor="{{ review.instructor.split|join:"_" }}" style="width: 100%" id="review">
      <div class="ui grid">
        <div class="four wide column">
          <div class="content" id="review-left-col">
            {# if review is anonymous, show generic image, else show facebook profile pic #}
            {% if review.anonymous == True %}
            <div class="ui horizontal list">
              <div class="item">
                <div class="ui sub header">
                  <img class="ui small circular image" src="{% static 'img/bulldog.png' %}" alt="" style="object-fit: contain;">
                  Anonymous
                </div>
              </div>
            </div>
            {% else %}
            <div class="ui horizontal list">
              <div class="item">
                <div class="ui sub header">
                  <img class="ui small circular image" src="{{ review.author.social_auth.all.0.extra_data.picture.data.url }}" alt="">
                  {{ review.author.social_auth.all.0.extra_data.name }}
                </div>
              </div>
            </div>
            {% endif %}
            <div class="item" id="meta-item">
              <div class="meta" id="review-meta">
                Session: {{ review.taken_season }} {{ review.taken_year }}
              </div>
              <div class="meta" id="review-meta">
                Instructor: {{ review.instructor }}
              </div>
              <div class="meta" id="review-meta">
                {{ review.created_at|date:"N jS, Y"  }}
              </div>
            </div>
          </div>
        </div>
        <div class="twelve wide column">
          <div class="ui grid">
            <div class="four column stackable row">
              <div class="column" id="review-column">
                <div class="meta">
                  Usefulness:
                  <div class="ui star rating" data-rating="{{ review.usefulness_rating }}"></div>
                </div>
              </div>
              <div class="column" id="review-column">
                <div class="meta">
                  Difficulty:
                  <div class="ui star rating" data-rating="{{ review.difficulty_rating }}"></div>
                </div>
              </div>
              <div class="column" id="review-column">
                <div class="meta">
                  Instructor:
                  <div class="ui star rating" data-rating="{{ review.instructor_rating }}"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="content">
            <p>
              {{ review.comment|linebreaks }}
            </p>
          </div>
        </div>
      </div>
      <div class="ui divider"></div>
      </div>
      {% endfor %}
      <div class="message-div">
        <p>There are currently no reviews for this instructor.</p>
      </div>
  </div>
  {% else %}
  <p>There are no reviews.</p>
  {% endif %}

  <button onclick="window.location.href = '{% url 'review' category=course.category number=course.number %}'" class="ui floated blue labeled icon button header-btn" id="review-button-test">
    <i class="star icon"></i>
    Write Review
  </button>
</div>


<script>

  $(document).ready(function() {

  var current_instructor = 0;

  $('.instructor-button').click(function() {
    var instructor = this.id;

    // if there is no instructor already selected
    if (current_instructor == 0) {
      current_instructor = instructor

      // hiding all the review divs
      $('.review').fadeOut(500)

      // checking to see if there is a review with the instructor selected
      if ($('.review[data-instructor="' + instructor + '"]').data('instructor') == undefined) {
        // if there isnt, let the user know
        $( '.message-div' ).show(500);
      } else {
        // otherwise, show the reviews that are for this instructor
        $('.review[data-instructor="' + instructor + '"]').fadeIn(500)
        $( '.message-div' ).hide();
      }
    } else {
      // if they click on the currently selected instructor
      if ($('.review[data-instructor="' + instructor + '"]').is(':visible')) {
        $('.review').show(500)
        current_instructor = 0
      } else {
        // if an instructor is selected and they choose another instructor
        current_instructor = instructor

        // hiding all the review divs
        $('.review').fadeOut(500)

        // checking to see if there is a review with the instructor selected
        if ($('.review[data-instructor="' + instructor + '"]').data('instructor') == undefined) {
          // if there isnt, let the user know
          $( '.message-div' ).show();
        } else {
          // otherwise, show the reviews that are for this instructor
          $('.review[data-instructor="' + instructor + '"]').fadeIn(500)
          $( '.message-div' ).hide();
        }
      }
    }
  });

    $('.message .close')
      .on('click', function() {
        $(this)
          .closest('.message')
          .transition('fade');
      });
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.1.1/pdfobject.min.js"></script>
<script>
  PDFObject.embed("{{ syllabus.syllabus.url }}", "#syllabus");
</script>
<script type="text/javascript" src="{% static 'js/dropzone.js' %}"></script>
<script type="text/javascript" src="{% static 'js/course.js' %}"></script>
<script type="text/javascript">
  $(document).ready(function() {
    $('.rating').rating({
      initialRating: 0,
      maxRating: 5
    });

    $('.rating').rating('disable')
  });
</script>
{% endblock content %}
